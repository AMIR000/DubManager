<?xml version="1.0"?>
<fx:Object xmlns:fx="http://ns.adobe.com/mxml/2009"
           xmlns:parsley="http://www.spicefactory.org/parsley">
    <fx:Declarations>
        <parsley:Object type="{WorkspacePM}">
            <parsley:ManagedEvents names="{[AnimeEvent.SAVE_DATA]}"/>

            <parsley:CommandResult selector="{AnimeEvent.LOAD_DATA}" type="{AnimeEvent}"
                                   method="onLoadResult"/>
        </parsley:Object>

        <parsley:Object type="{AnimeSelectPM}">
            <parsley:ManagedEvents names="{[AnimeEvent.LOAD_TITLES]}"/>

            <parsley:CommandResult selector="{AnimeEvent.LOAD_TITLES}" type="{AnimeEvent}"
                                   method="onLoadTitlesResult"/>
        </parsley:Object>

        <parsley:MapCommand selector="{AnimeEvent.LOAD_DATA}" messageType="{AnimeEvent}">
            <parsley:Command type="{LoadDataCommand}">
                <parsley:Property name="aStream" value="{aStreamData}"/>
            </parsley:Command>
        </parsley:MapCommand>

        <parsley:MapCommand selector="{AnimeEvent.SAVE_DATA}" messageType="{AnimeEvent}">
            <parsley:Command type="{SaveDataCommand}">
                <parsley:Property name="aStream" value="{aStreamData}"/>
            </parsley:Command>
        </parsley:MapCommand>

        <parsley:MapCommand selector="{AnimeEvent.LOAD_TITLES}" messageType="{AnimeEvent}">
            <parsley:Command type="{LoadAnimeTitlesCommand}">
                <parsley:Property name="aStream" value="{aStreamTitles}"/>
            </parsley:Command>
        </parsley:MapCommand>

        <parsley:MapCommand selector="{AnimeEvent.LOAD_LIST}" messageType="{AnimeEvent}">
            <parsley:Command type="{LoadAnimeListCommand}">
                <parsley:Property name="aStream" value="{aStreamData}"/>
            </parsley:Command>
        </parsley:MapCommand>

        <parsley:MapCommand selector="{AnimeEvent.LOAD}" messageType="{AnimeEvent}">
            <parsley:Command type="{LoadAnimeCommand}">
                <parsley:Property name="aStream" value="{aStreamData}"/>
            </parsley:Command>
        </parsley:MapCommand>

        <parsley:MapCommand selector="{AppEvent.UPDATE}" messageType="{AppEvent}">
            <parsley:Command type="{UpdateAppCommand}">
            </parsley:Command>
        </parsley:MapCommand>
    </fx:Declarations>

    <fx:Script><![CDATA[
        import ru.kokorin.astream.AStream;
        import ru.kokorin.astream.AStreamMode;
        import ru.kokorin.dubmanager.command.LoadAnimeCommand;
        import ru.kokorin.dubmanager.command.LoadAnimeListCommand;
        import ru.kokorin.dubmanager.command.LoadAnimeTitlesCommand;
        import ru.kokorin.dubmanager.command.LoadDataCommand;
        import ru.kokorin.dubmanager.command.SaveDataCommand;
        import ru.kokorin.dubmanager.command.UpdateAppCommand;
        import ru.kokorin.dubmanager.component.anime.AnimeSelectPM;
        import ru.kokorin.dubmanager.component.workspace.WorkspacePM;
        import ru.kokorin.dubmanager.domain.Anime;
        import ru.kokorin.dubmanager.domain.Title;
        import ru.kokorin.dubmanager.event.AnimeEvent;
        import ru.kokorin.dubmanager.event.AppEvent;

        public var aStreamData:AStream = function ():AStream {
            const result:AStream = new AStream();
            result.mode = AStreamMode.NO_REFERENCES;
            result.autodetectMetadata(true);
            result.alias("data", Vector.<Anime>);
            result.processMetadata(Anime);
            return result;
        }();

        public var aStreamTitles:AStream = function ():AStream {
            const result:AStream = new AStream();
            result.mode = AStreamMode.NO_REFERENCES;
            result.alias("animetitles", Vector.<Anime>);
            result.alias("anime", Anime);
            result.implicitCollection(Anime, "titles", "title", Title);
            result.processMetadata(Title);
            return result;
        }();
        ]]>
    </fx:Script>
</fx:Object>
